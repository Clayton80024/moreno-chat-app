(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,6085,e=>{"use strict";e.s(["Headers",()=>a,"Request",()=>n,"Response",()=>i,"default",()=>t,"fetch",()=>s]);var r="undefined"!=typeof self?self:"undefined"!=typeof window?window:e.g;let s=r.fetch,t=r.fetch.bind(r),a=r.Headers,n=r.Request,i=r.Response},33576,e=>{"use strict";e.s(["UserGroupIcon",()=>s],33576);var r=e.i(71645);let s=r.forwardRef(function(e,s){let{title:t,titleId:a,...n}=e;return r.createElement("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:1.5,stroke:"currentColor","aria-hidden":"true","data-slot":"icon",ref:s,"aria-labelledby":a},n),t?r.createElement("title",{id:a},t):null,r.createElement("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M18 18.72a9.094 9.094 0 0 0 3.741-.479 3 3 0 0 0-4.682-2.72m.94 3.198.001.031c0 .225-.012.447-.037.666A11.944 11.944 0 0 1 12 21c-2.17 0-4.207-.576-5.963-1.584A6.062 6.062 0 0 1 6 18.719m12 0a5.971 5.971 0 0 0-.941-3.197m0 0A5.995 5.995 0 0 0 12 12.75a5.995 5.995 0 0 0-5.058 2.772m0 0a3 3 0 0 0-4.681 2.72 8.986 8.986 0 0 0 3.74.477m.94-3.197a5.971 5.971 0 0 0-.94 3.197M15 6.75a3 3 0 1 1-6 0 3 3 0 0 1 6 0Zm6 3a2.25 2.25 0 1 1-4.5 0 2.25 2.25 0 0 1 4.5 0Zm-13.5 0a2.25 2.25 0 1 1-4.5 0 2.25 2.25 0 0 1 4.5 0Z"}))})},39875,e=>{"use strict";e.s(["MagnifyingGlassIcon",()=>s],39875);var r=e.i(71645);let s=r.forwardRef(function(e,s){let{title:t,titleId:a,...n}=e;return r.createElement("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:1.5,stroke:"currentColor","aria-hidden":"true","data-slot":"icon",ref:s,"aria-labelledby":a},n),t?r.createElement("title",{id:a},t):null,r.createElement("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z"}))})},27217,e=>{"use strict";e.s(["XMarkIcon",()=>s],27217);var r=e.i(71645);let s=r.forwardRef(function(e,s){let{title:t,titleId:a,...n}=e;return r.createElement("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:1.5,stroke:"currentColor","aria-hidden":"true","data-slot":"icon",ref:s,"aria-labelledby":a},n),t?r.createElement("title",{id:a},t):null,r.createElement("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M6 18 18 6M6 6l12 12"}))})},70011,e=>{"use strict";e.s(["ChatsService",()=>s]);var r=e.i(17927);class s{static async getUserChats(e){try{console.log("ðŸ”µ Getting user chats for:",e),console.log("ðŸ”µ Fetching user participation records...");let{data:n,error:i}=await r.supabase.from("chat_participants").select("chat_id, last_read_at").eq("user_id",e);if(i){var s,t,a;if(console.error("ðŸ”´ Error fetching user participants:",i),console.error("ðŸ”´ Error code:",i.code),console.error("ðŸ”´ Error message:",i.message),console.error("ðŸ”´ Error details:",i.details),console.error("ðŸ”´ Error hint:",i.hint),console.error("ðŸ”´ Full error object:",JSON.stringify(i,null,2)),(null==(s=i.message)?void 0:s.includes("infinite recursion"))||(null==(t=i.message)?void 0:t.includes("policy"))||(null==(a=i.message)?void 0:a.includes("permission"))||"42501"===i.code||"2BP01"===i.code||"42710"===i.code)return console.warn("âš ï¸ RLS policy issue detected, returning empty chats"),[];throw Error(i.message||"Unknown error")}if(!n||0===n.length)return console.log("ðŸ”µ No chat participants found for user"),[];let o=n.map(e=>e.chat_id);console.log("ðŸ”µ Found chat IDs:",o);let{data:l,error:c}=await r.supabase.from("chats").select("*").in("id",o).order("last_message_at",{ascending:!1});if(c)throw console.error("ðŸ”´ Error fetching chats:",c),Error(c.message);let d=await Promise.all((l||[]).map(async e=>{let s=n.find(r=>r.chat_id===e.id),t=[];try{let{data:s}=await r.supabase.from("chat_participants").select("*").eq("chat_id",e.id);if(s&&s.length>0){let e=s.map(e=>e.user_id),{data:a}=await r.supabase.from("user_profiles").select("id, full_name, username, avatar_url, bio, is_online, last_seen, location").in("id",e);t=s.map(e=>({...e,user_profile:null==a?void 0:a.find(r=>r.id===e.user_id)}))}}catch(r){console.warn("âš ï¸ Could not fetch participants for chat:",e.id,r)}let a=null;try{let{data:s}=await r.supabase.from("messages").select("*").eq("chat_id",e.id).order("created_at",{ascending:!1}).limit(1);if(s&&s.length>0){let e=s[0],{data:t}=await r.supabase.from("user_profiles").select("id, full_name, username, avatar_url, location").eq("id",e.sender_id).single();a={...e,sender_profile:t}}}catch(r){console.warn("âš ï¸ Could not fetch last message for chat:",e.id,r)}let i=0;try{let{count:t}=await r.supabase.from("messages").select("*",{count:"exact",head:!0}).eq("chat_id",e.id).gt("created_at",(null==s?void 0:s.last_read_at)||"1970-01-01");i=t||0}catch(r){console.warn("âš ï¸ Could not fetch unread count for chat:",e.id,r)}return{...e,participants:t,last_message:a,unread_count:i}}));return console.log("âœ… Successfully fetched user chats:",d.length),d}catch(e){return console.error("ðŸ”´ Error in getUserChats:",e),[]}}static async getChat(e,s){let{data:t,error:a}=await r.supabase.from("chat_participants").select("chat_id").eq("chat_id",e).eq("user_id",s).single();if(a||!t)throw Error("Chat not found or access denied");let{data:n,error:i}=await r.supabase.from("chats").select("*").eq("id",e).single();if(i)throw console.error("ðŸ”´ Error fetching chat:",i),Error(i.message);let{data:o}=await r.supabase.from("chat_participants").select("*").eq("chat_id",e),l=[];if(o&&o.length>0){let e=o.map(e=>e.user_id),{data:s}=await r.supabase.from("user_profiles").select("id, full_name, username, avatar_url, bio, is_online, last_seen, location").in("id",e);l=o.map(e=>({...e,user_profile:null==s?void 0:s.find(r=>r.id===e.user_id)}))}let{data:c}=await r.supabase.from("messages").select("*").eq("chat_id",e).order("created_at",{ascending:!1}).limit(1),d=null;if(c&&c.length>0){let e=c[0],{data:s}=await r.supabase.from("user_profiles").select("id, full_name, username, avatar_url, location").eq("id",e.sender_id).single();d={...e,sender_profile:s}}return{...n,participants:l||[],last_message:d||null}}static async createChat(e,s){try{console.log("ðŸ”µ Creating chat with creator:",e,"participants:",s.participant_ids);let{data:t,error:a}=await r.supabase.from("chats").insert({name:s.name||null,type:s.type,created_by:e}).select().single();if(a)throw console.error("ðŸ”´ Error creating chat:",a),console.error("ðŸ”´ Chat error details:",{code:a.code,message:a.message,details:a.details,hint:a.hint}),Error(a.message);console.log("âœ… Chat created successfully:",t);let n=[{chat_id:t.id,user_id:e},...s.participant_ids.map(e=>({chat_id:t.id,user_id:e}))];console.log("ðŸ”µ Adding participants:",n);let{error:i}=await r.supabase.from("chat_participants").insert(n);if(i)throw console.error("ðŸ”´ Error adding participants:",i),console.error("ðŸ”´ Participants error details:",{code:i.code,message:i.message,details:i.details,hint:i.hint}),Error(i.message);console.log("âœ… Participants added successfully");let o=await this.getChat(t.id,e);return console.log("âœ… Chat creation completed:",o),o}catch(e){throw console.error("ðŸ”´ Error in createChat:",e),e}}static async addParticipant(e,s,t){let{error:a}=await r.supabase.from("chat_participants").insert({chat_id:e,user_id:s});if(a)throw console.error("ðŸ”´ Error adding participant:",a),Error(a.message)}static async removeParticipant(e,s,t){let{error:a}=await r.supabase.from("chat_participants").delete().eq("chat_id",e).eq("user_id",s);if(a)throw console.error("ðŸ”´ Error removing participant:",a),Error(a.message)}static async getChatMessages(e,s){let t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:50,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;try{console.log("ðŸ”µ Getting messages for chat:",e,"user:",s);let{data:n,error:i}=await r.supabase.from("chat_participants").select("chat_id").eq("chat_id",e).eq("user_id",s).single();if(i||!n)throw console.error("ðŸ”´ User not participant in chat:",i),Error("Chat not found or access denied");console.log("âœ… User is participant in chat");let{data:o,error:l}=await r.supabase.from("messages").select("*").eq("chat_id",e).order("created_at",{ascending:!1}).range(a,a+t-1);if(l)throw console.error("ðŸ”´ Error fetching messages:",l),console.error("ðŸ”´ Error details:",{code:l.code,message:l.message,details:l.details,hint:l.hint}),Error(l.message);if(console.log("âœ… Messages fetched:",(null==o?void 0:o.length)||0),!o||0===o.length)return[];let c=[...new Set(o.map(e=>e.sender_id))];console.log("ðŸ”µ Getting profiles for senders:",c);let{data:d,error:u}=await r.supabase.from("user_profiles").select("id, full_name, username, avatar_url, location").in("id",c);u&&console.error("ðŸ”´ Error fetching profiles:",u),console.log("âœ… Profiles fetched:",(null==d?void 0:d.length)||0);let f=new Map;d&&d.forEach(e=>{f.set(e.id,e)});let g=await Promise.all(o.map(async e=>{try{let{data:s}=await r.supabase.from("message_status").select("*").eq("message_id",e.id),t=null;if(e.reply_to_id)try{let{data:s}=await r.supabase.from("messages").select("*").eq("id",e.reply_to_id).single();if(s){let e=f.get(s.sender_id);t={...s,sender_profile:e}}}catch(e){console.warn("âš ï¸ Error fetching reply message:",e)}return{...e,sender_profile:f.get(e.sender_id)||null,reply_to_message:t,status:s||[]}}catch(r){return console.warn("âš ï¸ Error fetching message status:",r),{...e,sender_profile:f.get(e.sender_id)||null,reply_to_message:null,status:[]}}}));return console.log("âœ… Messages processed with profiles and status"),g.reverse()}catch(e){throw console.error("ðŸ”´ Error in getChatMessages:",e),e}}static async sendMessage(e,s,t){let a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"text",n=arguments.length>4?arguments[4]:void 0;try{console.log("ðŸ”µ Sending message to chat:",e,"from:",s);let{data:i,error:o}=await r.supabase.from("chat_participants").select("chat_id").eq("chat_id",e).eq("user_id",s).single();if(o||!i)throw console.error("ðŸ”´ User not participant in chat:",o),Error("Chat not found or access denied");console.log("âœ… User is participant in chat");let{data:l,error:c}=await r.supabase.from("messages").insert({chat_id:e,sender_id:s,content:t,message_type:a,reply_to_id:n||null}).select("*").single();if(c)throw console.error("ðŸ”´ Error sending message:",c),console.error("ðŸ”´ Message error details:",{code:c.code,message:c.message,details:c.details,hint:c.hint}),Error(c.message);console.log("âœ… Message created successfully:",l.id);let{data:d,error:u}=await r.supabase.from("user_profiles").select("id, full_name, username, avatar_url, location").eq("id",s).single();u&&console.warn("âš ï¸ Error fetching sender profile:",u),console.log("âœ… Sender profile fetched:",(null==d?void 0:d.full_name)||"Unknown");try{let{error:e}=await r.supabase.from("message_status").insert({message_id:l.id,user_id:s,status:"sent",timestamp:new Date().toISOString()});e?console.warn("âš ï¸ Error creating message status:",e):console.log("âœ… Message status created")}catch(e){console.warn("âš ï¸ Error creating message status:",e)}let f={...l,sender_profile:d||null};return console.log("âœ… Message sent successfully with profile"),f}catch(e){throw console.error("ðŸ”´ Error in sendMessage:",e),e}}static async markMessagesAsRead(e,s){let{error:t}=await r.supabase.from("chat_participants").update({last_read_at:new Date().toISOString()}).eq("chat_id",e).eq("user_id",s);if(t)throw console.error("ðŸ”´ Error updating last_read_at:",t),Error(t.message);let{data:a,error:n}=await r.supabase.from("messages").select("id").eq("chat_id",e).gt("created_at",new Date().toISOString());if(n)return void console.error("ðŸ”´ Error fetching unread messages:",n);if(a&&a.length>0){let e=a.map(e=>({message_id:e.id,user_id:s,status:"read"}));await r.supabase.from("message_status").upsert(e,{onConflict:"message_id,user_id"})}}static async editMessage(e,s,t){let{data:a,error:n}=await r.supabase.from("messages").update({content:t,edited_at:new Date().toISOString()}).eq("id",e).eq("sender_id",s).select("*").single();if(n)throw console.error("ðŸ”´ Error editing message:",n),Error(n.message);let{data:i}=await r.supabase.from("user_profiles").select("id, full_name, username, avatar_url, location").eq("id",a.sender_id).single();return{...a,sender_profile:i}}static async deleteMessage(e,s){let{error:t}=await r.supabase.from("messages").delete().eq("id",e).eq("sender_id",s);if(t)throw console.error("ðŸ”´ Error deleting message:",t),Error(t.message)}static async getOrCreateDirectChat(e,s){let{data:t,error:a}=await r.supabase.from("chats").select("\n        id,\n        name,\n        type,\n        created_by,\n        created_at,\n        updated_at,\n        last_message_at\n      ").eq("type","direct").in("created_by",[e,s]);if(a&&"PGRST116"!==a.code)throw console.error("ðŸ”´ Error checking for existing chat:",a),Error(a.message);if(t&&t.length>0)for(let a of t){let{data:t,error:n}=await r.supabase.from("chat_participants").select("user_id").eq("chat_id",a.id).in("user_id",[e,s]);if(n){console.error("ðŸ”´ Error checking participants:",n);continue}if(t&&2===t.length)return await this.getChat(a.id,e)}return await this.createChat(e,{type:"direct",participant_ids:[s]})}}},65300,e=>{"use strict";e.s(["FriendsService",()=>s]);var r=e.i(17927);class s{static async testFriendRequestsTable(){try{let{data:e,error:s}=await r.supabase.from("friend_requests").select("id").limit(1);if(s)return console.error("ðŸ”´ friend_requests table test failed:",s),!1;return console.log("âœ… friend_requests table is accessible"),!0}catch(e){return console.error("ðŸ”´ friend_requests table test error:",e),!1}}static async testFriendsTable(){try{console.log("ðŸ”µ Testing friends table accessibility..."),console.log("ðŸ”µ Test 1: Basic select...");let{data:e,error:s}=await r.supabase.from("friends").select("id").limit(1);if(s){console.error("ðŸ”´ Test 1 failed:",s),console.error("ðŸ”´ Error code:",s.code),console.error("ðŸ”´ Error message:",s.message),console.error("ðŸ”´ Error details:",s.details),console.error("ðŸ”´ Error hint:",s.hint),console.error("ðŸ”´ Full error object:",JSON.stringify(s,null,2)),console.log("ðŸ”µ Test 2: Select with user filter...");let{data:e,error:t}=await r.supabase.from("friends").select("id").eq("user_id","00000000-0000-0000-0000-000000000000").limit(1);return t?(console.error("ðŸ”´ Test 2 also failed:",t),console.error("ðŸ”´ Error code:",t.code),console.error("ðŸ”´ Error message:",t.message)):console.log("âœ… Test 2 succeeded - issue might be with RLS policies"),!1}return console.log("âœ… friends table is accessible"),console.log("ðŸ”µ Test 1 data:",e),!0}catch(e){return console.error("ðŸ”´ friends table test error:",e),!1}}static async getFriends(e){let s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"accepted";try{if(console.log("ðŸ”µ Getting friends for user:",e,"with status:",s),!await this.testFriendsTable())return console.warn("âš ï¸ Friends table is not accessible, returning empty array"),[];let{data:n,error:i}=await r.supabase.from("friends").select("*").eq("user_id",e).eq("status",s).order("created_at",{ascending:!1});if(i){var t,a;if(console.error("ðŸ”´ Error fetching friends:",i),console.error("ðŸ”´ Error code:",i.code),console.error("ðŸ”´ Error message:",i.message),console.error("ðŸ”´ Error details:",i.details),console.error("ðŸ”´ Error hint:",i.hint),console.error("ðŸ”´ Full error object:",JSON.stringify(i,null,2)),(null==(t=i.message)?void 0:t.includes("permission"))||(null==(a=i.message)?void 0:a.includes("policy"))||"42501"===i.code||"2BP01"===i.code||"42710"===i.code)return console.warn("âš ï¸ RLS policy issue detected, returning empty friends array"),[];throw Error(i.message||"Failed to fetch friends")}let o=await Promise.all((n||[]).map(async e=>{try{let{data:s}=await r.supabase.from("user_profiles").select("id, full_name, username, avatar_url, bio, is_online, last_seen").eq("id",e.friend_id).single();return{...e,friend_profile:s}}catch(r){return console.warn("âš ï¸ Could not fetch friend profile for:",e.friend_id,r),{...e,friend_profile:null}}}));return console.log("âœ… Successfully fetched friends:",o.length),o}catch(e){return console.error("ðŸ”´ Error in getFriends:",e),[]}}static async getFriendRequests(e){try{var s,t;console.log("ðŸ”µ Getting friend requests for user:",e),console.log("ðŸ”µ User ID type:",typeof e,"Length:",e.length);let{data:a,error:n}=await r.supabase.from("friend_requests").select("id").limit(1);if(n)return console.error("ðŸ”´ Error accessing friend_requests table:",n),console.error("ðŸ”´ Test error details:",{code:n.code,message:n.message,details:n.details,hint:n.hint}),{sent:[],received:[]};console.log("âœ… friend_requests table is accessible"),console.log("ðŸ”µ Test data:",a);let{data:i,error:o}=await r.supabase.from("friend_requests").select("*").limit(10);console.log("ðŸ”µ All friend requests in table:",i),console.log("ðŸ”µ All requests error:",o);let[l,c]=await Promise.all([r.supabase.from("friend_requests").select("*").eq("sender_id",e).eq("status","pending").order("created_at",{ascending:!1}),r.supabase.from("friend_requests").select("*").eq("receiver_id",e).eq("status","pending").order("created_at",{ascending:!1})]);console.log("ðŸ”µ Sent requests result:",l),console.log("ðŸ”µ Received requests result:",c),console.log("ðŸ”µ Sent requests count:",(null==(s=l.data)?void 0:s.length)||0),console.log("ðŸ”µ Received requests count:",(null==(t=c.data)?void 0:t.length)||0),l.error&&(console.error("ðŸ”´ Error fetching sent requests:",l.error),console.error("ðŸ”´ Sent error details:",{code:l.error.code,message:l.error.message,details:l.error.details,hint:l.error.hint})),c.error&&(console.error("ðŸ”´ Error fetching received requests:",c.error),console.error("ðŸ”´ Received error details:",{code:c.error.code,message:c.error.message,details:c.error.details,hint:c.error.hint}));let d=await Promise.all((l.data||[]).map(async e=>{try{let{data:s}=await r.supabase.from("user_profiles").select("id, full_name, username, avatar_url, bio, is_online").eq("id",e.receiver_id).single();return{...e,receiver_profile:s}}catch(r){return console.error("ðŸ”´ Error fetching receiver profile:",r),{...e,receiver_profile:null}}})),u=await Promise.all((c.data||[]).map(async e=>{try{let{data:s}=await r.supabase.from("user_profiles").select("id, full_name, username, avatar_url, bio, is_online").eq("id",e.sender_id).single();return{...e,sender_profile:s}}catch(r){return console.error("ðŸ”´ Error fetching sender profile:",r),{...e,sender_profile:null}}}));return console.log("âœ… Successfully fetched friend requests:",{sent:d.length,received:u.length}),{sent:d,received:u}}catch(e){return console.error("ðŸ”´ Error in getFriendRequests:",e),{sent:[],received:[]}}}static async sendFriendRequest(e,s,t){try{console.log("ðŸ”µ Sending friend request from:",e,"to:",s);let a=await this.debugFriendshipData(e,s);a.inconsistencies.length>0&&(console.warn("âš ï¸ Data inconsistencies found:",a.inconsistencies),console.warn("âš ï¸ Friends data:",a.friendsData),console.warn("âš ï¸ Friend requests data:",a.friendRequestsData)),console.log("ðŸ”µ Checking for existing friendship...");let[n,i]=await Promise.all([r.supabase.from("friends").select("id, status, user_id, friend_id").eq("user_id",e).eq("friend_id",s).maybeSingle(),r.supabase.from("friends").select("id, status, user_id, friend_id").eq("user_id",s).eq("friend_id",e).maybeSingle()]),o=n.data||i.data;if(o){if(console.log("ðŸ”´ Existing friendship found:",o),console.log("ðŸ”´ Friendship status:",o.status),console.log("ðŸ”´ Friendship user_id:",o.user_id),console.log("ðŸ”´ Friendship friend_id:",o.friend_id),"accepted"===o.status)throw Error("You are already friends with this user");if("pending"===o.status)throw Error("A friendship request is already pending between you and this user");if("blocked"===o.status)throw Error("This user has been blocked");else throw Error("A friendship relationship already exists between you and this user")}console.log("âœ… No existing friendship found"),console.log("ðŸ”µ Checking for existing friend request...");let[l,c]=await Promise.all([r.supabase.from("friend_requests").select("id, status, sender_id, receiver_id").eq("sender_id",e).eq("receiver_id",s).maybeSingle(),r.supabase.from("friend_requests").select("id, status, sender_id, receiver_id").eq("sender_id",s).eq("receiver_id",e).maybeSingle()]),d=l.data||c.data;if(d){if(console.log("ðŸ”´ Friend request already exists:",d),console.log("ðŸ”´ Request status:",d.status),console.log("ðŸ”´ Request sender:",d.sender_id),console.log("ðŸ”´ Request receiver:",d.receiver_id),"pending"===d.status)if(d.sender_id===e)throw Error("You have already sent a friend request to this user");else throw Error("This user has already sent you a friend request. Please check your received requests.");if("accepted"===d.status)throw Error("You are already friends with this user");if("declined"===d.status)throw Error("Your previous friend request was declined. Please wait before sending another request.");else throw Error("A friend request already exists between you and this user")}console.log("âœ… No existing friend request found"),console.log("ðŸ”µ Creating friend request...");let{data:u,error:f}=await r.supabase.from("friend_requests").insert({sender_id:e,receiver_id:s,message:t||null,status:"pending"}).select().single();if(f)throw console.error("ðŸ”´ Error sending friend request:",f),console.error("ðŸ”´ Error code:",f.code),console.error("ðŸ”´ Error message:",f.message),console.error("ðŸ”´ Error details:",f.details),console.error("ðŸ”´ Error hint:",f.hint),Error(f.message||"Failed to send friend request");return console.log("âœ… Successfully sent friend request:",u),u}catch(e){throw console.error("ðŸ”´ Error in sendFriendRequest:",e),e}}static async acceptFriendRequest(e,s){try{if(console.log("ðŸ”µ Accepting friend request:",e,"for user:",s),!await this.testFriendsTable())throw Error("Friends table is not accessible. Please check RLS policies.");let{data:a,error:n}=await r.supabase.from("friend_requests").select("*").eq("id",e).eq("receiver_id",s).eq("status","pending").single();if(n){var t;if(console.error("ðŸ”´ Error fetching friend request:",n),console.error("ðŸ”´ Error code:",n.code),console.error("ðŸ”´ Error message:",n.message),"PGRST116"===n.code)throw Error("Friend request not found or already processed");if(null==(t=n.message)?void 0:t.includes("permission"))throw Error("You do not have permission to accept this request");throw Error("Friend request not found")}if(console.log("ðŸ”µ Found friend request:",a),await this.areFriends(a.sender_id,a.receiver_id)){console.log("âš ï¸ Users are already friends, updating request status"),await r.supabase.from("friend_requests").update({status:"accepted"}).eq("id",e);let{data:t}=await r.supabase.from("friends").select("*").eq("user_id",s).eq("friend_id",a.sender_id).eq("status","accepted").single();return t}let{error:i}=await r.supabase.from("friend_requests").update({status:"accepted"}).eq("id",e).eq("status","pending");if(i)throw console.error("ðŸ”´ Error updating friend request:",i),console.error("ðŸ”´ Error code:",i.code),console.error("ðŸ”´ Error message:",i.message),Error(i.message);console.log("ðŸ”µ Updated friend request status to accepted"),console.log("ðŸ”µ Creating friendship records...");let{data:o,error:l}=await r.supabase.from("friends").insert([{user_id:a.sender_id,friend_id:a.receiver_id,status:"accepted"},{user_id:a.receiver_id,friend_id:a.sender_id,status:"accepted"}]).select();if(l)throw console.error("ðŸ”´ Error creating friendship:",l),console.error("ðŸ”´ Error code:",l.code),console.error("ðŸ”´ Error message:",l.message),console.error("ðŸ”´ Error details:",l.details),console.error("ðŸ”´ Error hint:",l.hint),console.error("ðŸ”´ Full error object:",JSON.stringify(l,null,2)),await r.supabase.from("friend_requests").update({status:"pending"}).eq("id",e),Error(l.message||"Failed to create friendship");return console.log("âœ… Successfully created friendships:",o),o[0]}catch(e){throw console.error("ðŸ”´ Error in acceptFriendRequest:",e),e}}static async declineFriendRequest(e,s){try{console.log("ðŸ”µ Declining friend request:",e,"for user:",s);let{data:a,error:n}=await r.supabase.from("friend_requests").select("*").eq("id",e).eq("receiver_id",s).eq("status","pending").single();if(n){var t;if(console.error("ðŸ”´ Error fetching friend request:",n),console.error("ðŸ”´ Error code:",n.code),console.error("ðŸ”´ Error message:",n.message),"PGRST116"===n.code)throw Error("Friend request not found or already processed");if(null==(t=n.message)?void 0:t.includes("permission"))throw Error("You do not have permission to decline this request");throw Error("Friend request not found")}console.log("ðŸ”µ Found friend request to decline:",a);let{error:i}=await r.supabase.from("friend_requests").update({status:"declined"}).eq("id",e).eq("status","pending");if(i)throw console.error("ðŸ”´ Error declining friend request:",i),console.error("ðŸ”´ Error code:",i.code),console.error("ðŸ”´ Error message:",i.message),Error(i.message||"Failed to decline friend request");console.log("âœ… Successfully declined friend request")}catch(e){throw console.error("ðŸ”´ Error in declineFriendRequest:",e),e}}static async cancelFriendRequest(e,s){try{console.log("ðŸ”µ Canceling friend request:",e,"for user:",s);let{error:t}=await r.supabase.from("friend_requests").delete().eq("id",e).eq("sender_id",s).eq("status","pending");if(t)throw console.error("ðŸ”´ Error canceling friend request:",t),console.error("ðŸ”´ Error code:",t.code),console.error("ðŸ”´ Error message:",t.message),Error(t.message||"Failed to cancel friend request");console.log("âœ… Successfully canceled friend request")}catch(e){throw console.error("ðŸ”´ Error in cancelFriendRequest:",e),e}}static async removeFriend(e,s){try{console.log("ðŸ”µ Removing friend:",e,s);let[t,a]=await Promise.all([r.supabase.from("friends").delete().eq("user_id",e).eq("friend_id",s),r.supabase.from("friends").delete().eq("user_id",s).eq("friend_id",e)]);if(t.error)throw console.error("ðŸ”´ Error removing friend (direction 1):",t.error),Error(t.error.message);if(a.error)throw console.error("ðŸ”´ Error removing friend (direction 2):",a.error),Error(a.error.message);console.log("âœ… Successfully removed friend")}catch(e){throw console.error("ðŸ”´ Error in removeFriend:",e),e}}static async blockUser(e,s){await this.removeFriend(e,s);let{error:t}=await r.supabase.from("friends").insert({user_id:e,friend_id:s,status:"blocked"});if(t)throw console.error("ðŸ”´ Error blocking user:",t),Error(t.message)}static async unblockUser(e,s){let{error:t}=await r.supabase.from("friends").delete().eq("user_id",e).eq("friend_id",s).eq("status","blocked");if(t)throw console.error("ðŸ”´ Error unblocking user:",t),Error(t.message)}static async searchUsers(e,s){let t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:20;if(!e.trim())return[];let{data:a,error:n}=await r.supabase.from("user_profiles").select("\n        id,\n        full_name,\n        username,\n        avatar_url,\n        bio,\n        location,\n        is_online,\n        last_seen\n      ").neq("id",s).or("full_name.ilike.%".concat(e,"%,username.ilike.%").concat(e,"%")).limit(t);if(n)throw console.error("ðŸ”´ Error searching users:",n),Error(n.message);return await Promise.all((a||[]).map(async e=>{let{count:t}=await r.supabase.from("friends").select("*",{count:"exact",head:!0}).eq("user_id",s).eq("status","accepted").in("friend_id",[...await r.supabase.from("friends").select("friend_id").eq("user_id",e.id).eq("status","accepted").then(e=>{var r;return(null==(r=e.data)?void 0:r.map(e=>e.friend_id))||[]})]);return{...e,mutual_friends:t||0}}))}static async debugFriendshipData(e,s){try{console.log("ðŸ”µ Debugging friendship data between:",e,s);let[t,a]=await Promise.all([r.supabase.from("friends").select("*").eq("user_id",e).eq("friend_id",s),r.supabase.from("friends").select("*").eq("user_id",s).eq("friend_id",e)]),[n,i]=await Promise.all([r.supabase.from("friend_requests").select("*").eq("sender_id",e).eq("receiver_id",s),r.supabase.from("friend_requests").select("*").eq("sender_id",s).eq("receiver_id",e)]),o=[...t.data||[],...a.data||[]],l=[...n.data||[],...i.data||[]],c=[];return console.log("ðŸ”µ Friends data:",o),console.log("ðŸ”µ Friend requests data:",l),o.length>2&&c.push("More than 2 friendship records found (should be max 2 - one in each direction)"),l.length>2&&c.push("More than 2 friend request records found (should be max 2 - one in each direction)"),o.filter(e=>"accepted"===e.status).length>0&&l.length>0&&c.push("Found accepted friendships AND friend requests - this should not happen"),{friendsData:o,friendRequestsData:l,inconsistencies:c}}catch(e){return console.error("ðŸ”´ Error debugging friendship data:",e),{friendsData:[],friendRequestsData:[],inconsistencies:["Error occurred while debugging"]}}}static async getFriendRequestStatus(e,s){try{console.log("ðŸ”µ Checking friend request status between:",e,s);let[t,a]=await Promise.all([r.supabase.from("friend_requests").select("*").eq("sender_id",e).eq("receiver_id",s).maybeSingle(),r.supabase.from("friend_requests").select("*").eq("sender_id",s).eq("receiver_id",e).maybeSingle()]),n=t.data||a.data;if(!n){if(await this.areFriends(e,s))return{status:"accepted"};return{status:"none"}}if(n.sender_id===e)return{status:"pending"===n.status?"pending_sent":n.status,request:n};return{status:"pending"===n.status?"pending_received":n.status,request:n}}catch(e){return console.error("ðŸ”´ Error checking friend request status:",e),{status:"none"}}}static async areFriends(e,s){try{console.log("ðŸ”µ Checking if users are friends:",e,s);let[t,a]=await Promise.all([r.supabase.from("friends").select("id").eq("user_id",e).eq("friend_id",s).eq("status","accepted").maybeSingle(),r.supabase.from("friends").select("id").eq("user_id",s).eq("friend_id",e).eq("status","accepted").maybeSingle()]),n=!!(t.data||a.data);return console.log("ðŸ”µ Are friends result:",n),n}catch(e){return console.error("ðŸ”´ Error checking friendship:",e),!1}}static async getMutualFriends(e,s){let{data:t,error:a}=await r.supabase.from("friends").select("friend_id").eq("user_id",e).eq("status","accepted");if(a)throw console.error("ðŸ”´ Error fetching user1 friends:",a),Error(a.message);let{data:n,error:i}=await r.supabase.from("friends").select("friend_id").eq("user_id",s).eq("status","accepted");if(i)throw console.error("ðŸ”´ Error fetching user2 friends:",i),Error(i.message);let o=(null==t?void 0:t.map(e=>e.friend_id))||[],l=(null==n?void 0:n.map(e=>e.friend_id))||[],c=o.filter(e=>l.includes(e));if(0===c.length)return[];let{data:d,error:u}=await r.supabase.from("user_profiles").select("\n        id,\n        full_name,\n        username,\n        avatar_url,\n        bio,\n        location,\n        is_online,\n        last_seen\n      ").in("id",c);if(u)throw console.error("ðŸ”´ Error fetching mutual friends profiles:",u),Error(u.message);return d||[]}}},47604,e=>{"use strict";e.s(["ChatBubbleLeftRightIcon",()=>s],47604);var r=e.i(71645);let s=r.forwardRef(function(e,s){let{title:t,titleId:a,...n}=e;return r.createElement("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:1.5,stroke:"currentColor","aria-hidden":"true","data-slot":"icon",ref:s,"aria-labelledby":a},n),t?r.createElement("title",{id:a},t):null,r.createElement("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M20.25 8.511c.884.284 1.5 1.128 1.5 2.097v4.286c0 1.136-.847 2.1-1.98 2.193-.34.027-.68.052-1.02.072v3.091l-3-3c-1.354 0-2.694-.055-4.02-.163a2.115 2.115 0 0 1-.825-.242m9.345-8.334a2.126 2.126 0 0 0-.476-.095 48.64 48.64 0 0 0-8.048 0c-1.131.094-1.976 1.057-1.976 2.192v4.286c0 .837.46 1.58 1.155 1.951m9.345-8.334V6.637c0-1.621-1.152-3.026-2.76-3.235A48.455 48.455 0 0 0 11.25 3c-2.115 0-4.198.137-6.24.402-1.608.209-2.76 1.614-2.76 3.235v6.226c0 1.621 1.152 3.026 2.76 3.235.577.075 1.157.14 1.74.194V21l4.155-4.155"}))})},55344,e=>{"use strict";e.s(["RealtimeProvider",()=>c,"useRealtime",()=>d],55344);var r=e.i(43476),s=e.i(71645),t=e.i(17927),a=e.i(83642),n=e.i(70011),i=e.i(65300);class o{static async testPresenceTable(){try{console.log("ðŸ”µ Testing user_presence table accessibility...");let{data:e,error:r}=await t.supabase.from("user_presence").select("id").limit(1);if(r)return console.error("ðŸ”´ user_presence table test failed:",r),console.error("ðŸ”´ Error code:",r.code),console.error("ðŸ”´ Error message:",r.message),console.error("ðŸ”´ Error details:",r.details),console.error("ðŸ”´ Error hint:",r.hint),!1;return console.log("âœ… user_presence table is accessible"),console.log("ðŸ”µ Test data:",e),!0}catch(e){return console.error("ðŸ”´ user_presence table test error:",e),!1}}static async updateStatus(e,r){try{if(console.log("ðŸ”µ Updating user status:",e,"to:",r),!await this.testPresenceTable())throw Error("User presence table is not accessible. Please check RLS policies.");let{data:n,error:i}=await t.supabase.from("user_presence").upsert({user_id:e,status:r,last_seen:new Date().toISOString()},{onConflict:"user_id"}).select().single();if(i){var s,a;if(console.error("ðŸ”´ Error updating user status:",i),console.error("ðŸ”´ Error code:",i.code),console.error("ðŸ”´ Error message:",i.message),console.error("ðŸ”´ Error details:",i.details),console.error("ðŸ”´ Error hint:",i.hint),console.error("ðŸ”´ Full error object:",JSON.stringify(i,null,2)),(null==(s=i.message)?void 0:s.includes("row-level security"))||(null==(a=i.message)?void 0:a.includes("policy"))||"42501"===i.code)throw Error("Permission denied: Unable to update presence status. Please check RLS policies.");throw Error(i.message||"Failed to update user status")}console.log("âœ… Successfully updated user status:",n);try{let{error:s}=await t.supabase.from("user_profiles").update({is_online:"online"===r,last_seen:new Date().toISOString()}).eq("id",e);s?console.warn("âš ï¸ Error updating user profile:",s):console.log("âœ… Successfully updated user profile")}catch(e){console.warn("âš ï¸ Error updating user profile:",e)}return n}catch(e){throw console.error("ðŸ”´ Error in updateStatus:",e),e}}static async getUserStatus(e){let{data:r,error:s}=await t.supabase.from("user_presence").select("*").eq("user_id",e).single();if(s){if("PGRST116"===s.code)return null;throw console.error("ðŸ”´ Error fetching user status:",s),Error(s.message)}return r}static async getOnlineFriends(e){let{data:r,error:s}=await t.supabase.from("friends").select("\n        friend_id,\n        friend_profile:user_profiles!friends_friend_id_fkey(\n          id,\n          full_name,\n          username,\n          avatar_url,\n          is_online,\n          last_seen\n        ),\n        presence:user_presence!friends_friend_id_fkey(\n          status,\n          last_seen\n        )\n      ").eq("user_id",e).eq("status","accepted");if(s)throw console.error("ðŸ”´ Error fetching online friends:",s),Error(s.message);return(r||[]).filter(e=>{let r=Array.isArray(e.presence)?e.presence[0]:e.presence;return(null==r?void 0:r.status)==="online"}).map(e=>{let r=Array.isArray(e.friend_profile)?e.friend_profile[0]:e.friend_profile,s=Array.isArray(e.presence)?e.presence[0]:e.presence;return{id:r.id,full_name:r.full_name,username:r.username,avatar_url:r.avatar_url,is_online:!0,last_seen:s.last_seen,status:s.status}})}static async getOnlineUsers(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:50,{data:r,error:s}=await t.supabase.from("user_presence").select("\n        *,\n        user_profile:user_profiles!user_presence_user_id_fkey(\n          id,\n          full_name,\n          username,\n          avatar_url,\n          is_online,\n          last_seen\n        )\n      ").eq("status","online").order("last_seen",{ascending:!1}).limit(e);if(s)throw console.error("ðŸ”´ Error fetching online users:",s),Error(s.message);return(r||[]).map(e=>({id:e.user_profile.id,full_name:e.user_profile.full_name,username:e.user_profile.username,avatar_url:e.user_profile.avatar_url,is_online:!0,last_seen:e.last_seen,status:e.status}))}static async setAway(e){await this.updateStatus(e,"away")}static async setOffline(e){await this.updateStatus(e,"offline")}static async setOnline(e){await this.updateStatus(e,"online")}static async getRecentlyActiveUsers(e){let r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:20,s=new Date(Date.now()-864e5).toISOString(),{data:a,error:n}=await t.supabase.from("user_presence").select("\n        *,\n        user_profile:user_profiles!user_presence_user_id_fkey(\n          id,\n          full_name,\n          username,\n          avatar_url,\n          is_online,\n          last_seen\n        )\n      ").neq("user_id",e).gte("last_seen",s).order("last_seen",{ascending:!1}).limit(r);if(n)throw console.error("ðŸ”´ Error fetching recently active users:",n),Error(n.message);return(a||[]).map(e=>({id:e.user_profile.id,full_name:e.user_profile.full_name,username:e.user_profile.username,avatar_url:e.user_profile.avatar_url,is_online:"online"===e.status,last_seen:e.last_seen,status:e.status}))}static subscribeToPresenceChanges(e,r){return t.supabase.channel("presence_changes").on("postgres_changes",{event:"*",schema:"public",table:"user_presence",filter:"user_id=eq.".concat(e)},e=>{r(e.new)}).subscribe()}static subscribeToFriendsPresence(e,r){return t.supabase.from("friends").select("friend_id").eq("user_id",e).eq("status","accepted").then(e=>{let{data:s}=e;if(!s||0===s.length)return null;let a=s.map(e=>e.friend_id);return t.supabase.channel("friends_presence").on("postgres_changes",{event:"*",schema:"public",table:"user_presence",filter:"user_id=in.(".concat(a.join(","),")")},e=>{r(e.new)}).subscribe()})}}let l=(0,s.createContext)(void 0);function c(e){let{children:c}=e,{user:d}=(0,a.useAuth)(),[u,f]=(0,s.useState)([]),[g,p]=(0,s.useState)(null),[h,m]=(0,s.useState)([]),[_,w]=(0,s.useState)({}),[b,q]=(0,s.useState)({sent:[],received:[]}),[y,v]=(0,s.useState)([]),[E,S]=(0,s.useState)([]),[x,F]=(0,s.useState)(null),[k,C]=(0,s.useState)(!1),[R,P]=(0,s.useState)(null),[T,j]=(0,s.useState)([]),O=(0,s.useRef)([]);(0,s.useEffect)(()=>{if(!d){T.forEach(e=>{t.supabase.removeChannel(e)}),j([]),f([]),p(null),m([]),w({}),q({sent:[],received:[]}),v([]),S([]),F(null),C(!1);return}let e=setTimeout(()=>{N()},100);return()=>{clearTimeout(e),T.forEach(e=>{t.supabase.removeChannel(e)})}},[d]);let N=async()=>{try{C(!1),P(null),await Promise.all([A(),U(),D(),M()]),await L(),C(!0)}catch(e){console.error("ðŸ”´ Error initializing realtime:",e),P(e instanceof Error?e.message:"Failed to connect")}},A=async()=>{if(d)try{let e=await n.ChatsService.getUserChats(d.id);f(e),O.current=e;let r={};e.forEach(e=>{r[e.id]=e.unread_count||0}),w(r)}catch(e){console.error("ðŸ”´ Error loading chats:",e)}},U=async()=>{if(d)try{if(console.log("ðŸ”µ Loading friend requests for user:",d.id),!await i.FriendsService.testFriendRequestsTable()){console.warn("âš ï¸ friend_requests table is not accessible, skipping friend requests"),q({sent:[],received:[]});return}let e=await i.FriendsService.getFriendRequests(d.id);console.log("âœ… Friend requests loaded:",e);let r={sent:e.sent.filter(e=>"pending"===e.status),received:e.received.filter(e=>"pending"===e.status)},s={sent:r.sent.filter((e,r,s)=>r===s.findIndex(r=>r.id===e.id)),received:r.received.filter((e,r,s)=>r===s.findIndex(r=>r.id===e.id))};console.log("âœ… Deduplicated friend requests (pending only):",s),q(s)}catch(e){console.error("ðŸ”´ Error loading friend requests:",e),console.error("ðŸ”´ Error details:",{message:e instanceof Error?e.message:"Unknown error",user:d.id}),q({sent:[],received:[]})}},D=async()=>{if(d)try{let e=(await i.FriendsService.getFriends(d.id,"accepted")).filter((e,r,s)=>r===s.findIndex(r=>r.id===e.id));v(e)}catch(e){console.error("ðŸ”´ Error loading friends:",e),v([])}},M=async()=>{if(d)try{let e=await o.getUserStatus(d.id);F(e),(null==e?void 0:e.status)!=="online"&&await o.setOnline(d.id)}catch(e){console.error("ðŸ”´ Error loading user presence:",e)}},L=async()=>{if(!d)return;let e=[],r=t.supabase.channel("user_messages").on("postgres_changes",{event:"INSERT",schema:"public",table:"messages"},async e=>{let r=e.new;if(console.log("ðŸ”µ New message received:",r),!O.current.some(e=>e.id===r.chat_id))try{let{data:e,error:s}=await t.supabase.from("chat_participants").select("chat_id").eq("chat_id",r.chat_id).eq("user_id",d.id).single();if(s||!e)return void console.log("ðŸ”µ User not participant in chat, ignoring message:",null==s?void 0:s.message)}catch(e){console.log("ðŸ”µ Error checking participant status, ignoring message:",e);return}m(e=>[...e.filter(e=>!(e.id.startsWith("temp-")&&e.sender_id===r.sender_id&&e.content===r.content&&e.chat_id===r.chat_id)),r]),f(e=>(0===e.length&&(console.log("ðŸ”µ Chats array is empty, refreshing..."),A()),e)),f(e=>{let s=e.map(e=>e.id===r.chat_id?{...e,last_message:r,last_message_at:r.created_at,unread_count:r.sender_id!==d.id?(e.unread_count||0)+1:e.unread_count||0}:e);return O.current=s,s}),r.sender_id!==d.id&&w(e=>({...e,[r.chat_id]:(e[r.chat_id]||0)+1}))}).subscribe();e.push(r);let s=t.supabase.channel("friend_requests").on("postgres_changes",{event:"*",schema:"public",table:"friend_requests",filter:"or(sender_id.eq.".concat(d.id,",receiver_id.eq.").concat(d.id,")")},async e=>{console.log("ðŸ”µ Friend request change detected:",e),console.log("ðŸ”µ Event type:",e.eventType),console.log("ðŸ”µ New data:",e.new),console.log("ðŸ”µ Old data:",e.old),"INSERT"===e.eventType?console.log("ðŸ”µ New friend request created"):"UPDATE"===e.eventType?(console.log("ðŸ”µ Friend request updated:",e.new),"pending"!==e.new.status&&console.log("ðŸ”µ Request processed, removing from pending list")):"DELETE"===e.eventType&&console.log("ðŸ”µ Friend request deleted"),console.log("ðŸ”µ Refreshing friend requests in 100ms..."),setTimeout(async()=>{console.log("ðŸ”µ Executing refresh now..."),await Promise.all([U(),D()]),console.log("ðŸ”µ Refresh completed")},100)}).subscribe(e=>{console.log("ðŸ”µ Friend requests channel status:",e)});e.push(s);let a=t.supabase.channel("friends").on("postgres_changes",{event:"*",schema:"public",table:"friends",filter:"user_id.eq.".concat(d.id)},async()=>{await Promise.all([A(),D()])}).subscribe();e.push(a);let n=t.supabase.channel("friends_presence").on("postgres_changes",{event:"*",schema:"public",table:"user_presence"},async e=>{let r=e.new;"online"===r.status?S(e=>[...new Set([...e,r.user_id])]):S(e=>e.filter(e=>e!==r.user_id))}).subscribe();e.push(n);let i=t.supabase.channel("chat_participants").on("postgres_changes",{event:"*",schema:"public",table:"chat_participants",filter:"user_id.eq.".concat(d.id)},async()=>{await A()}).subscribe();e.push(i),j(e)},I=(0,s.useCallback)(async(e,r,s)=>{var t,a,i;if(!d)return;let o={id:"temp-".concat(Date.now()),chat_id:e,sender_id:d.id,content:r.trim(),message_type:"text",reply_to_id:s||null,edited_at:null,created_at:new Date().toISOString(),updated_at:new Date().toISOString(),sender_profile:{id:d.id,full_name:(null==(t=d.user_metadata)?void 0:t.full_name)||"",username:(null==(a=d.user_metadata)?void 0:a.username)||"",avatar_url:(null==(i=d.user_metadata)?void 0:i.avatar_url)||null,location:null}};m(e=>[...e,o]);try{await n.ChatsService.sendMessage(e,d.id,r,"text",s)}catch(e){throw m(e=>e.filter(e=>e.id!==o.id)),console.error("ðŸ”´ Error sending message:",e),e}},[d]),B=(0,s.useCallback)(async e=>{if(d)try{await n.ChatsService.markMessagesAsRead(e,d.id),w(r=>({...r,[e]:0})),f(r=>r.map(r=>r.id===e?{...r,unread_count:0}:r))}catch(e){console.error("ðŸ”´ Error marking messages as read:",e)}},[d]),G=(0,s.useCallback)(async()=>{await A()},[]),Y=(0,s.useCallback)(async()=>{await U()},[]),J=(0,s.useCallback)(e=>{q(r=>({...r,sent:[...r.sent,e]}))},[]),W=(0,s.useCallback)(async e=>{if(d)try{let r=await n.ChatsService.getChatMessages(e,d.id);m(s=>[...s.filter(r=>r.chat_id!==e),...r]),await B(e)}catch(e){console.error("ðŸ”´ Error loading chat messages:",e)}},[d,B]);return(0,s.useEffect)(()=>{g&&d&&W(g.id)},[null==g?void 0:g.id,null==d?void 0:d.id,W]),(0,s.useEffect)(()=>{if(!d)return;o.setOnline(d.id);let e=()=>{document.hidden?o.setAway(d.id):o.setOnline(d.id)},r=()=>{o.setOffline(d.id)};return document.addEventListener("visibilitychange",e),window.addEventListener("beforeunload",r),()=>{document.removeEventListener("visibilitychange",e),window.removeEventListener("beforeunload",r),o.setOffline(d.id)}},[d]),(0,r.jsx)(l.Provider,{value:{chats:u,currentChat:g,messages:h,unreadCounts:_,friendRequests:b,friends:y,onlineFriends:E,userPresence:x,setCurrentChat:p,sendMessage:I,markMessagesAsRead:B,refreshChats:G,refreshFriendRequests:Y,addOptimisticFriendRequest:J,loadChatMessages:W,isConnected:k,connectionError:R},children:c})}function d(){let e=(0,s.useContext)(l);if(void 0===e)throw Error("useRealtime must be used within a RealtimeProvider");return e}},50057,e=>{"use strict";e.s(["ConnectionStatus",()=>n,"OnlineFriendsList",()=>a,"StatusIndicator",()=>t]);var r=e.i(43476),s=e.i(55344);function t(e){let{userId:t,size:a="md",showText:n=!1}=e,{onlineFriends:i}=(0,s.useRealtime)(),o=i.includes(t);return(0,r.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,r.jsx)("div",{className:"".concat({sm:"w-2 h-2",md:"w-3 h-3",lg:"w-4 h-4"}[a]," rounded-full ").concat(o?"bg-green-500 border-2 border-white dark:border-gray-800":"bg-gray-400 border-2 border-white dark:border-gray-800")}),n&&(0,r.jsx)("span",{className:"".concat({sm:"text-xs",md:"text-sm",lg:"text-base"}[a]," text-gray-600 dark:text-gray-400"),children:o?"Online":"Offline"})]})}function a(e){let{maxDisplay:a=5}=e,{chats:n}=(0,s.useRealtime)(),i=n.filter(e=>"direct"===e.type).map(e=>{var r;return null==(r=e.participants)?void 0:r.find(r=>r.user_id!==e.created_by)}).filter(Boolean).filter((e,r,s)=>r===s.findIndex(r=>(null==r?void 0:r.user_id)===(null==e?void 0:e.user_id))).slice(0,a);return(console.log("ðŸ”µ OnlineFriendsList - chats:",n.length),console.log("ðŸ”µ OnlineFriendsList - onlineFriends:",i.length),console.log("ðŸ”µ OnlineFriendsList - user_ids:",i.map(e=>null==e?void 0:e.user_id)),0===i.length)?(0,r.jsx)("div",{className:"text-sm text-gray-500 dark:text-gray-400",children:"No friends online"}):(0,r.jsxs)("div",{className:"space-y-2",children:[(0,r.jsx)("h4",{className:"text-sm font-medium text-gray-700 dark:text-gray-300",children:"Online Friends"}),(0,r.jsx)("div",{className:"space-y-1",children:i.map((e,s)=>{var a,n,i,o,l,c,d;return(0,r.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,r.jsx)("div",{className:"w-6 h-6 rounded-full bg-gray-300 dark:bg-gray-600 flex items-center justify-center",children:(null==e||null==(a=e.user_profile)?void 0:a.avatar_url)?(0,r.jsx)("img",{src:e.user_profile.avatar_url,alt:e.user_profile.full_name||e.user_profile.username||"Friend",className:"w-6 h-6 rounded-full object-cover"}):(0,r.jsx)("span",{className:"text-xs text-gray-600 dark:text-gray-400",children:(null==e||null==(i=e.user_profile)||null==(n=i.full_name)?void 0:n[0])||(null==e||null==(l=e.user_profile)||null==(o=l.username)?void 0:o[0])||"?"})}),(0,r.jsx)("div",{className:"flex-1 min-w-0",children:(0,r.jsx)("p",{className:"text-sm text-gray-900 dark:text-white truncate",children:(null==e||null==(c=e.user_profile)?void 0:c.full_name)||(null==e||null==(d=e.user_profile)?void 0:d.username)||"Unknown"})}),(0,r.jsx)(t,{userId:(null==e?void 0:e.user_id)||"",size:"sm"})]},"online-friend-".concat(null==e?void 0:e.user_id,"-").concat(s))})})]})}function n(e){let{className:t=""}=e,{isConnected:a,connectionError:n}=(0,s.useRealtime)();return n?(0,r.jsxs)("div",{className:"flex items-center space-x-2 text-red-500 ".concat(t),children:[(0,r.jsx)("div",{className:"w-2 h-2 bg-red-500 rounded-full"}),(0,r.jsx)("span",{className:"text-sm",children:"Connection Error"})]}):(0,r.jsxs)("div",{className:"flex items-center space-x-2 ".concat(t),children:[(0,r.jsx)("div",{className:"w-2 h-2 rounded-full ".concat(a?"bg-green-500":"bg-yellow-500")}),(0,r.jsx)("span",{className:"text-sm text-gray-600 dark:text-gray-400",children:a?"Connected":"Connecting..."})]})}},99749,e=>{"use strict";function r(e,r,s){return r in e?Object.defineProperty(e,r,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[r]=s,e}e.s(["_",()=>r])}]);